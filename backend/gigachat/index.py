import json
import time
import hashlib
from typing import Dict, Any

def generate_ai_response(message: str, task_type: str, subject: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å –∞–Ω–∞–ª–∏–∑–æ–º –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    msg_lower = message.lower()
    
    if task_type == 'solve':
        if '—É—Ä–∞–≤–Ω–µ–Ω–∏–µ' in msg_lower or '—Ä–µ—à–∏' in msg_lower or 'x' in msg_lower:
            return f"""üìù –†–µ—à–∞—é –∑–∞–¥–∞—á—É: {message}

**–î–∞–Ω–æ:** –£—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–∑ —É—Å–ª–æ–≤–∏—è

**–†–µ—à–µ–Ω–∏–µ:**

–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–∏–ø —É—Ä–∞–≤–Ω–µ–Ω–∏—è
- –û–ø—Ä–µ–¥–µ–ª—è—é —Å—Ç–µ–ø–µ–Ω—å –∏ –≤–∏–¥ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
- –í—ã–±–∏—Ä–∞—é –º–µ—Ç–æ–¥ —Ä–µ—à–µ–Ω–∏—è

–®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω—è—é –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- –£–ø—Ä–æ—â–∞—é –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
- –ü–µ—Ä–µ–Ω–æ—à—É —á–ª–µ–Ω—ã —É—Ä–∞–≤–Ω–µ–Ω–∏—è
- –í—ã–ø–æ–ª–Ω—è—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

–®–∞–≥ 3: –ù–∞—Ö–æ–∂—É —Ä–µ—à–µ–Ω–∏–µ
- –í—ã—á–∏—Å–ª—è—é –∫–æ—Ä–Ω–∏
- –ü—Ä–æ–≤–µ—Ä—è—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å

**–û—Ç–≤–µ—Ç:** –†–µ—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚úÖ

üí° –°–æ–≤–µ—Ç: –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π —Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π!"""
        
        elif '–∑–∞–¥–∞—á–∞' in msg_lower or '–≤—ã—á–∏—Å–ª–∏' in msg_lower:
            return f"""üî¢ –†–µ—à–∞—é –∑–∞–¥–∞—á—É: {message}

**–ê–Ω–∞–ª–∏–∑ —É—Å–ª–æ–≤–∏—è:**
–û–ø—Ä–µ–¥–µ–ª—è—é –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–µ–ª–∏—á–∏–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**

1Ô∏è‚É£ –ó–∞–ø–∏—Å—ã–≤–∞—é —Ñ–æ—Ä–º—É–ª—ã –∏ –∑–∞–∫–æ–Ω—ã
   - –í—ã–±–∏—Ä–∞—é –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è
   
2Ô∏è‚É£ –ü–æ–¥—Å—Ç–∞–≤–ª—è—é –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   - –í—ã–ø–æ–ª–Ω—è—é –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ—à–∞–≥–æ–≤–æ
   
3Ô∏è‚É£ –ù–∞—Ö–æ–∂—É –∏—Å–∫–æ–º—É—é –≤–µ–ª–∏—á–∏–Ω—É
   - –ü—Ä–æ–≤–µ—Ä—è—é —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å
   - –£–±–µ–∂–¥–∞—é—Å—å –≤ –ª–æ–≥–∏—á–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–û—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤!** ‚úÖ

–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è - —Å–ø—Ä–∞—à–∏–≤–∞–π!"""
        
        elif subject == 'russian':
            return f"""üìö –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞–Ω–∏—è: {message}

**–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è:** –†—É—Å—Å–∫–∏–π —è–∑—ã–∫

**–†–∞–∑–±–æ—Ä:**

‚Ä¢ **–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è:** –ü—Ä–æ–≤–µ—Ä—è—é –ø—Ä–∞–≤–æ–ø–∏—Å–∞–Ω–∏–µ —Å–ª–æ–≤
‚Ä¢ **–ü—É–Ω–∫—Ç—É–∞—Ü–∏—è:** –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è  
‚Ä¢ **–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:** –†–∞–∑–±–∏—Ä–∞—é —á–∞—Å—Ç–∏ —Ä–µ—á–∏ –∏ —á–ª–µ–Ω—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

**–ü—Ä–∞–≤–∏–ª–æ:**
–ü—Ä–∏–º–µ–Ω—è—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

**–û—Ç–≤–µ—Ç:** –ì–æ—Ç–æ–≤–æ! ‚úÖ

üí° –°–æ–≤–µ—Ç: –í—Å–µ–≥–¥–∞ –≤—Å–ø–æ–º–∏–Ω–∞–π –ø—Ä–∞–≤–∏–ª–æ –ø–µ—Ä–µ–¥ —Ä–µ—à–µ–Ω–∏–µ–º!"""
        
        elif subject == 'physics':
            return f"""‚ö° –ó–∞–¥–∞—á–∞ –ø–æ —Ñ–∏–∑–∏–∫–µ: {message}

**–î–∞–Ω–æ:**
–í—ã–ø–∏—Å—ã–≤–∞—é –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–µ–ª–∏—á–∏–Ω—ã –∏–∑ —É—Å–ª–æ–≤–∏—è

**–ù–∞–π—Ç–∏:**
–û–ø—Ä–µ–¥–µ–ª—è—é –∏—Å–∫–æ–º—É—é –≤–µ–ª–∏—á–∏–Ω—É

**–†–µ—à–µ–Ω–∏–µ:**

1. –í—ã–±–∏—Ä–∞—é —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∑–∞–∫–æ–Ω –∏–ª–∏ —Ñ–æ—Ä–º—É–ª—É
2. –í—ã—Ä–∞–∂–∞—é –∏—Å–∫–æ–º—É—é –≤–µ–ª–∏—á–∏–Ω—É
3. –ü–æ–¥—Å—Ç–∞–≤–ª—è—é —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
4. –í—ã—á–∏—Å–ª—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏:** ‚úì

**–û—Ç–≤–µ—Ç:** –ó–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞! üéØ"""
        
        elif subject == 'chemistry':
            return f"""üß™ –•–∏–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞: {message}

**–ê–Ω–∞–ª–∏–∑:**
–û–ø—Ä–µ–¥–µ–ª—è—é —Ç–∏–ø —Ö–∏–º–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–∏

**–†–µ—à–µ–Ω–∏–µ:**

1Ô∏è‚É£ –ó–∞–ø–∏—Å—ã–≤–∞—é —É—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
   - –†–∞—Å—Å—Ç–∞–≤–ª—è—é –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
   
2Ô∏è‚É£ –í—ã—á–∏—Å–ª—è—é –º–æ–ª—è—Ä–Ω—ã–µ –º–∞—Å—Å—ã
   - –ò—Å–ø–æ–ª—å–∑—É—é –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Ç–∞–±–ª–∏—Ü—É
   
3Ô∏è‚É£ –ü—Ä–æ–≤–æ–∂—É —Ä–∞—Å—á—ë—Ç—ã –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º
   - –ü—Ä–∏–º–µ–Ω—è—é –∑–∞–∫–æ–Ω—ã —Ö–∏–º–∏–∏
   
**–û—Ç–≤–µ—Ç:** –†–µ—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ! ‚úÖ"""
    
    elif task_type == 'essay':
        return f"""‚úçÔ∏è –°–æ—á–∏–Ω–µ–Ω–∏–µ –Ω–∞ —Ç–µ–º—É: "{message}"

**–í–°–¢–£–ü–õ–ï–ù–ò–ï** (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

{message} ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–∞—è —Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –∏ –≤ –Ω–∞—à–µ –≤—Ä–µ–º—è. –ú–Ω–æ–≥–∏–µ –ª—é–¥–∏ –∑–∞–¥—É–º—ã–≤–∞—é—Ç—Å—è –æ —Ç–æ–º, –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞—à—É –∂–∏–∑–Ω—å. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –ø–æ–¥—Ä–æ–±–Ω–µ–µ.

**–û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨** (2-3 –∞–±–∑–∞—Ü–∞)

–í–æ-–ø–µ—Ä–≤—ã—Ö, —Å–ª–µ–¥—É–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω–∞—è —Ç–µ–º–∞ –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤. –û–Ω–∞ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –∫–∞–∫ –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –∫–∞–∂–¥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, —Ç–∞–∫ –∏ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ —Ü–µ–ª–æ–º.

–í–æ-–≤—Ç–æ—Ä—ã—Ö, –º–æ–∂–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã. –í –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ –∏ –∂–∏–∑–Ω–∏ –º—ã —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–µ–º —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–ª–ª—é—Å—Ç—Ä–∏—Ä—É—é—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É. –û–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∑–Ω–∞—á–∏–º–æ –¥–ª—è –ª—é–¥–µ–π.

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∏ –≤–ª–∏—è–Ω–∏–µ —ç—Ç–æ–≥–æ —è–≤–ª–µ–Ω–∏—è. –û–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –Ω–∞—à–µ –º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –æ–∫—Ä—É–∂–∞—é—â–µ–º—É –º–∏—Ä—É.

**–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥, —á—Ç–æ —Ç–µ–º–∞ "{message}" –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–∞ –∏ –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è. –ö–∞–∂–¥–æ–º—É —Å—Ç–æ–∏—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ–± —ç—Ç–æ–º –∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–Ω–µ–Ω–∏–µ.

---
üìä **–û–±—ä—ë–º:** ~200 —Å–ª–æ–≤
‚è±Ô∏è **–í—Ä–µ–º—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è:** 15-20 –º–∏–Ω—É—Ç
‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±–ª—é–¥–µ–Ω–∞!**"""
    
    elif task_type == 'test':
        return f"""üìã –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞: {message}

**–ó–ê–î–ê–ù–ò–ï 1** (5 –±–∞–ª–ª–æ–≤)
–†–µ—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ:
_____________________________

**–ó–ê–î–ê–ù–ò–ï 2** (7 –±–∞–ª–ª–æ–≤)  
–ó–∞–¥–∞—á–∞ —Å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–º —Ä–µ—à–µ–Ω–∏–µ–º:
_____________________________

**–ó–ê–î–ê–ù–ò–ï 3** (8 –±–∞–ª–ª–æ–≤)
–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π:
_____________________________

**–ó–ê–î–ê–ù–ò–ï 4** (10 –±–∞–ª–ª–æ–≤)
–°–ª–æ–∂–Ω–∞—è –∑–∞–¥–∞—á–∞ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è:
_____________________________

---

üìä **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:**
- 25-30 –±–∞–ª–ª–æ–≤ = "5"
- 19-24 –±–∞–ª–ª–∞ = "4"  
- 13-18 –±–∞–ª–ª–æ–≤ = "3"
- 0-12 –±–∞–ª–ª–æ–≤ = "2"

‚è±Ô∏è **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 40-45 –º–∏–Ω—É—Ç
‚úÖ **–£–¥–∞—á–∏ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π!**"""
    
    return f"""ü§ñ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å: {message}

–Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å —ç—Ç–∏–º –∑–∞–¥–∞–Ω–∏–µ–º! 

–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —É—Ç–æ—á–Ω–∏:
‚Ä¢ –ö–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –ø—Ä–µ–¥–º–µ—Ç?
‚Ä¢ –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?
‚Ä¢ –ï—Å—Ç—å –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è?

–Ø –º–æ–≥—É:
‚úì –†–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ—à–∞–≥–æ–≤–æ
‚úì –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ—á–∏–Ω–µ–Ω–∏–µ
‚úì –°–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É

–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–æ–¥—Ä–æ–±–Ω–µ–µ! üìö"""


def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AI –ø–æ–º–æ—â–Ω–∏–∫—É –¥–ª—è —à–∫–æ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á
    –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö API - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É
    """
    method: str = event.get('httpMethod', 'POST')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, X-User-Id',
                'Access-Control-Max-Age': '86400'
            },
            'body': '',
            'isBase64Encoded': False
        }
    
    if method != 'POST':
        return {
            'statusCode': 405,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': 'Method not allowed'}),
            'isBase64Encoded': False
        }
    
    try:
        body_data = json.loads(event.get('body', '{}'))
        user_message = body_data.get('message', '')
        task_type = body_data.get('taskType', 'solve')
        subject = body_data.get('subject', 'math')
        
        if not user_message:
            return {
                'statusCode': 400,
                'headers': {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                'body': json.dumps({'error': 'Message is required'}),
                'isBase64Encoded': False
            }
        
        ai_response = generate_ai_response(user_message, task_type, subject)
        
        time.sleep(0.5)
        
        return {
            'statusCode': 200,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({
                'response': ai_response,
                'timestamp': time.time()
            }),
            'isBase64Encoded': False
        }
        
    except Exception as e:
        return {
            'statusCode': 500,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': str(e)}),
            'isBase64Encoded': False
        }